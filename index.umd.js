/**
 * The MIT License (MIT)
 *
 * Copyright (c) 2017 Jakub Beneš <benes@webscope.io>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("react"),require("prop-types")):"function"==typeof define&&define.amd?define(["react","prop-types"],t):e.ReactTextareaAutocomplete=t(e.React,e.PropTypes)}(this,function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function c(e,t){var n={};for(var r in e)t.indexOf(r)>=0||Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=e[r]);return n}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function f(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function p(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t;var d=function(e,t){return t={exports:{}},e(t,t.exports),t.exports}(function(e){!function(){var t=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","borderStyle","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing","tabSize","MozTabSize"],n="undefined"!=typeof window,r=n&&null!=window.mozInnerScreenX;e.exports=function(e,o,i){if(!n)throw new Error("textarea-caret-position#getCaretCoordinates should only be called in a browser");var a=i&&i.debug||!1;if(a){var s=document.querySelector("#input-textarea-caret-position-mirror-div");s&&s.parentNode.removeChild(s)}var l=document.createElement("div");l.id="input-textarea-caret-position-mirror-div",document.body.appendChild(l);var c=l.style,u=window.getComputedStyle?getComputedStyle(e):e.currentStyle;c.whiteSpace="pre-wrap","INPUT"!==e.nodeName&&(c.wordWrap="break-word"),c.position="absolute",a||(c.visibility="hidden"),t.forEach(function(e){c[e]=u[e]}),r?e.scrollHeight>parseInt(u.height)&&(c.overflowY="scroll"):c.overflow="hidden",l.textContent=e.value.substring(0,o),"INPUT"===e.nodeName&&(l.textContent=l.textContent.replace(/\s/g," "));var f=document.createElement("span");f.textContent=e.value.substring(o)||".",l.appendChild(f);var p={top:f.offsetTop+parseInt(u.borderTopWidth),left:f.offsetLeft+parseInt(u.borderLeftWidth)};return a?f.style.backgroundColor="#aaa":document.body.removeChild(l),p}}()}),g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},h={ESC:27,UP:38,DOWN:40,ENTER:13,TAB:9},v=new function e(){var t=this;n(this,e),this.startListen=function(){t.isListening||(document.addEventListener("keydown",t.f),t.isListening=!0)},this.stopListen=function(){document.removeEventListener("keydown",t.f),t.isListening=!1},this.add=function(e,n){var r=e;return"object"!==(void 0===r?"undefined":g(r))&&(r=[r]),t.listeners[t.index]={keyCode:r,fn:n},t.index+=1,t.index},this.remove=function(e){delete t.listeners[e],t.index-=1},this.removeAll=function(){t.listeners={},t.index=0},this.index=0,this.listeners={},this.isListening=!1,this.f=function(e){for(var n=e.keyCode||e.which,r=0;r<t.index;r+=1){var o=t.listeners[r],i=o.keyCode,a=o.fn;i.includes(n)&&a(e)}}},y=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),m=function(t){function n(){var e,t,i,a;r(this,n);for(var s=arguments.length,l=Array(s),c=0;c<s;c++)l[c]=arguments[c];return t=i=o(this,(e=n.__proto__||Object.getPrototypeOf(n)).call.apply(e,[this].concat(l))),i.selectItem=function(){var e=i.props,t=e.item;(0,e.onSelectHandler)(t)},a=t,o(i,a)}return i(n,e.Component),y(n,[{key:"render",value:function(){var t=this.props,n=t.component,r=t.onClickHandler,o=t.item,i=t.selected;return e.createElement("li",{className:"rta__item"},e.createElement("div",{className:"rta__entity "+(!0===i?"rta__entity--selected":""),role:"button",tabIndex:0,onClick:r,onFocus:this.selectItem,onMouseEnter:this.selectItem},e.createElement(n,{selected:i,entity:o})))}}]),n}(),b=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),w=function(t){function n(){var e,t,r,o;a(this,n);for(var i=arguments.length,l=Array(i),c=0;c<i;c++)l[c]=arguments[c];return t=r=s(this,(e=n.__proto__||Object.getPrototypeOf(n)).call.apply(e,[this].concat(l))),r.state={selectedItem:null},r.onPressEnter=function(e){e.preventDefault();var t=r.props.values;r.modifyText(t[r.getPositionInList()])},r.getPositionInList=function(){var e=r.props.values,t=r.state.selectedItem;return t?e.findIndex(function(e){return r.getId(e)===r.getId(t)}):0},r.getId=function(e){return r.props.getTextToReplace(e)},r.listeners=[],r.modifyText=function(e){if(e){var t=r.props;(0,t.onSelect)((0,t.getTextToReplace)(e))}},r.selectItem=function(e){r.setState({selectedItem:e})},r.scroll=function(e){e.preventDefault();var t=r.props.values,n=e.keyCode||e.which,o=r.getPositionInList(),i=void 0;switch(n){case h.DOWN:i=o+1;break;case h.UP:i=o-1;break;default:i=o}i=(i%t.length+t.length)%t.length,r.setState({selectedItem:t[i]})},r.isSelected=function(e){var t=r.state.selectedItem;return!!t&&r.getId(t)===r.getId(e)},o=t,s(r,o)}return l(n,e.Component),b(n,[{key:"componentDidMount",value:function(){this.listeners.push(v.add([h.DOWN,h.UP],this.scroll),v.add([h.ENTER,h.TAB],this.onPressEnter));var e=this.props.values;e&&e[0]&&this.selectItem(e[0])}},{key:"componentWillReceiveProps",value:function(e){var t=e.values;t&&t[0]&&this.selectItem(t[0])}},{key:"componentWillUnmount",value:function(){for(var e=void 0;this.listeners.length;)e=this.listeners.pop(),v.remove(e)}},{key:"render",value:function(){var t=this,n=this.props,r=n.values,o=n.component;return e.createElement("ul",{className:"rta__list"},r.map(function(n){return e.createElement(m,{key:t.getId(n),selected:t.isSelected(n),item:n,onClickHandler:t.onPressEnter,onSelectHandler:t.selectItem,component:o})}))}}]),n}(),S="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_=function(){function e(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(o)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),C=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),E=function(t){function n(e){u(this,n);var t=f(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));x.call(t),v.add(h.ESC,function(){return t._closeAutocomplete()});var r=t.props,o=r.loadingComponent,i=r.trigger,a=r.value;if(a&&(t.state.value=a),t.tokenRegExp=new RegExp("["+Object.keys(i).join("")+"]\\w*$"),!o)throw new Error("RTA: loadingComponent is not defined");if(!i)throw new Error("RTA: trigger is not defined");return t}return p(n,e.Component),C(n,[{key:"componentDidMount",value:function(){v.startListen()}},{key:"componentWillReceiveProps",value:function(e){this._update(e)}},{key:"componentWillUnmount",value:function(){v.stopListen()}},{key:"_update",value:function(e){var t=e.value,n=e.trigger,r=this.state.value,o=this.props.trigger;t===r&&r||this.setState({value:t}),n===o&&this.tokenRegExp||(this.tokenRegExp=new RegExp("["+Object.keys(n).join("")+"]\\w*$"))}},{key:"render",value:function(){var t=this,n=this.props,r=n.loadingComponent,o=n.style,i=n.containerStyle,a=c(n,["loadingComponent","style","containerStyle"]),s=this.state,l=s.left,u=s.top,f=s.dataLoading,p=s.component,d=s.value,g=this._getSuggestions(),h=this._getTextToReplace();return e.createElement("div",{className:"rta "+(!0===f?"rta--loading":""),style:i},e.createElement("textarea",Object.assign({},this._cleanUpProps(),{ref:function(e){t.textareaRef=e},className:"rta__textarea "+(a.className||""),onChange:this._changeHandler,onSelect:this._selectHandler,value:d,style:o})),(f||g)&&e.createElement("div",{style:{top:u,left:l},className:"rta__autocomplete"},g&&p&&h&&e.createElement(w,{values:g,component:p,getTextToReplace:h,onSelect:this._onSelect}),f&&e.createElement("div",{className:"rta__loader "+(null!==g?"rta__loader--suggestion-data":"rta__loader--empty-suggestion-data")},e.createElement(r,{data:g}))))}}]),n}();E.defaultProps={containerStyle:void 0,minChar:1,onChange:void 0,onCaretPositionChange:void 0,style:void 0,value:""};var x=function(){var e=this;this.state={top:0,left:0,currentTrigger:null,actualToken:"",data:null,value:"",dataLoading:!1,selectionEnd:0,selectionStart:0,component:null},this.setCaretPosition=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;e.textareaRef&&(e.textareaRef.focus(),e.textareaRef.setSelectionRange(t,t))},this.getCaretPosition=function(){return e.textareaRef?e.textareaRef.selectionEnd:0},this._onSelect=function(t){for(var n=e.state,r=n.selectionEnd,o=n.value,i=e.props.onChange,a=0;o[r+a]&&/\S/.test(o[r+a]);)a+=1;var s=o.slice(0,r+a),l=s.search(/\S*$/),c=l+t.length,u=s.substring(0,l)+t;e.setState({value:o.replace(s,u),dataLoading:!1},function(){var t=new Event("change",{bubbles:!0});e.textareaRef.dispatchEvent(t),i&&i(t),e.setCaretPosition(c)}),e._closeAutocomplete()},this._getTextToReplace=function(){var t=e.state.currentTrigger,n=e._getCurrentTriggerSettings();if(!t||!n)return function(){return""};var r=n.output;return function(e){if("object"===(void 0===e?"undefined":S(e))&&(!r||"function"!=typeof r))throw new Error("RTA: Output function is not defined!");return r?r(e,t):""+t+e+t}},this._getCurrentTriggerSettings=function(){var t=e.state.currentTrigger;return t?e.props.trigger[t]:null},this._getValuesFromProvider=function(){var t=e.state,n=t.currentTrigger,r=t.actualToken,o=e._getCurrentTriggerSettings();if(n&&o){var i=o.dataProvider,a=o.component;if("function"!=typeof i)throw new Error("RTA: Trigger provider has to be a function!");e.setState({dataLoading:!0});var s=i(r);s instanceof Promise||(s=Promise.resolve(s)),s.then(function(t){if("object"!==(void 0===s?"undefined":S(s)))throw new Error("RTA: Trigger provider has to provide an array!");if("function"!=typeof a)throw new Error("RTA: Component should be defined!");e.setState({dataLoading:!1,data:t,component:a})}).catch(function(e){throw new Error("RTA: dataProvider fails: "+e.message)})}},this._getSuggestions=function(){var t=e.state,n=t.currentTrigger,r=t.data;return!n||!r||r&&!r.length?null:r},this._closeAutocomplete=function(){e._getSuggestions()&&e.setState({data:null})},this._cleanUpProps=function(){var t=Object.assign({},e.props),n=["loadingComponent","containerStyle","minChar","ref","onChange","onCaretPositionChange","className","value","trigger"];for(var r in t)n.includes(r)&&delete t[r];return t},this._changeHandler=function(t){var n=e.props,r=n.trigger,o=n.onChange,i=n.minChar,a=n.onCaretPositionChange,s=t.target,l=s.selectionEnd,c=s.selectionStart,u=s.value;o&&(t.persist(),o(t)),a&&a(e.getCaretPosition()),e.setState({value:u});var f=e.tokenRegExp.exec(u.slice(0,l)),p=f&&f[0];if(!p||p.length<=i)e._closeAutocomplete();else{var g=Object.keys(r),h=p&&g.find(function(e){return e===p[0]})||null,v=p.slice(1);if(h){var y=d(s,l),m=y.top,b=y.left;e.setState({top:m,left:b}),e.setState({selectionEnd:l,selectionStart:c,currentTrigger:h,actualToken:v},e._getValuesFromProvider)}}},this._selectHandler=function(){var t=e.props.onCaretPositionChange;t&&t(e.getCaretPosition())}};return E.propTypes={containerStyle:t.object,loadingComponent:t.func.isRequired,minChar:t.number,onChange:t.func,onCaretPositionChange:t.func,style:t.object,trigger:function(e){var t=e.trigger;if(!t)return Error("Invalid prop trigger. Prop missing.");for(var n=Object.entries(t),r=0;r<n.length;r+=1){var o=_(n[r],2),i=o[0],a=o[1];if("string"!=typeof i||1!==i.length)return Error("Invalid prop trigger. Keys of the object has to be string.");var s=a.component,l=a.dataProvider;if(!s||"function"!=typeof s)return Error("Invalid prop trigger: component should be defined.");if(!l||"function"!=typeof l)return Error("Invalid prop trigger: dataProvider should be defined.")}return null},value:t.string},E});
