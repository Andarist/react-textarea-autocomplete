/**
 * The MIT License (MIT)
 *
 * Copyright (c) 2017 Jakub Bene≈° <benes@webscope.io>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}function _classCallCheck$1(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck$3(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn$2(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits$2(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck$2(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn$1(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits$1(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _objectWithoutProperties(e,t){var n={};for(var r in e)t.indexOf(r)>=0||Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=e[r]);return n}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var React=_interopDefault(require("react")),PropTypes=_interopDefault(require("prop-types")),getCaretCoordinates=_interopDefault(require("textarea-caret")),_typeof$1="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},KEY_CODES={ESC:27,UP:38,DOWN:40,ENTER:13,TAB:9},Listener=function e(){var t=this;_classCallCheck$1(this,e),this.startListen=function(){t.isListening||(document.addEventListener("keydown",t.f),t.isListening=!0)},this.stopListen=function(){document.removeEventListener("keydown",t.f),t.isListening=!1},this.add=function(e,n){var r=e;return"object"!==(void 0===r?"undefined":_typeof$1(r))&&(r=[r]),t.listeners[t.index]={keyCode:r,fn:n},t.index+=1,t.index},this.remove=function(e){delete t.listeners[e],t.index-=1},this.removeAll=function(){t.listeners={},t.index=0},this.index=0,this.listeners={},this.isListening=!1,this.f=function(e){for(var n=e.keyCode||e.which,r=0;r<t.index;r+=1){var o=t.listeners[r],i=o.keyCode,a=o.fn;i.includes(n)&&a(e)}}},Listeners=new Listener,_createClass$2=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),Item=function(e){function t(){var e,n,r,o;_classCallCheck$3(this,t);for(var i=arguments.length,a=Array(i),s=0;s<i;s++)a[s]=arguments[s];return n=r=_possibleConstructorReturn$2(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(a))),r.selectItem=function(){var e=r.props,t=e.item;(0,e.onSelectHandler)(t)},o=n,_possibleConstructorReturn$2(r,o)}return _inherits$2(t,React.Component),_createClass$2(t,[{key:"render",value:function(){var e=this.props,t=e.component,n=e.onClickHandler,r=e.item,o=e.selected;return React.createElement("li",{className:"rta__item"},React.createElement("div",{className:"rta__entity "+(!0===o?"rta__entity--selected":""),role:"button",tabIndex:0,onClick:n,onFocus:this.selectItem,onMouseEnter:this.selectItem},React.createElement(t,{selected:o,entity:r})))}}]),t}(),_createClass$1=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),List=function(e){function t(){var e,n,r,o;_classCallCheck$2(this,t);for(var i=arguments.length,a=Array(i),s=0;s<i;s++)a[s]=arguments[s];return n=r=_possibleConstructorReturn$1(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(a))),r.state={selectedItem:null},r.onPressEnter=function(e){e.preventDefault();var t=r.props.values;r.modifyText(t[r.getPositionInList()])},r.getPositionInList=function(){var e=r.props.values,t=r.state.selectedItem;return t?e.findIndex(function(e){return r.getId(e)===r.getId(t)}):0},r.getId=function(e){return r.props.getTextToReplace(e)},r.listeners=[],r.modifyText=function(e){if(e){var t=r.props;(0,t.onSelect)((0,t.getTextToReplace)(e))}},r.selectItem=function(e){r.setState({selectedItem:e})},r.scroll=function(e){e.preventDefault();var t=r.props.values,n=e.keyCode||e.which,o=r.getPositionInList(),i=void 0;switch(n){case KEY_CODES.DOWN:i=o+1;break;case KEY_CODES.UP:i=o-1;break;default:i=o}i=(i%t.length+t.length)%t.length,r.setState({selectedItem:t[i]})},r.isSelected=function(e){var t=r.state.selectedItem;return!!t&&r.getId(t)===r.getId(e)},o=n,_possibleConstructorReturn$1(r,o)}return _inherits$1(t,React.Component),_createClass$1(t,[{key:"componentDidMount",value:function(){this.listeners.push(Listeners.add([KEY_CODES.DOWN,KEY_CODES.UP],this.scroll),Listeners.add([KEY_CODES.ENTER,KEY_CODES.TAB],this.onPressEnter));var e=this.props.values;e&&e[0]&&this.selectItem(e[0])}},{key:"componentWillReceiveProps",value:function(e){var t=e.values;t&&t[0]&&this.selectItem(t[0])}},{key:"componentWillUnmount",value:function(){for(var e=void 0;this.listeners.length;)e=this.listeners.pop(),Listeners.remove(e)}},{key:"render",value:function(){var e=this,t=this.props,n=t.values,r=t.component;return React.createElement("ul",{className:"rta__list"},n.map(function(t){return React.createElement(Item,{key:e.getId(t),selected:e.isSelected(t),item:t,onClickHandler:e.onPressEnter,onSelectHandler:e.selectItem,component:r})}))}}]),t}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_slicedToArray=function(){function e(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(o)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),ReactTextareaAutocomplete=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));_initialiseProps.call(n),Listeners.add(KEY_CODES.ESC,function(){return n.closeAutocomplete()});var r=n.props,o=r.loadingComponent,i=r.trigger,a=r.value;if(a&&(n.state.value=a),n.tokenRegExp=new RegExp("["+Object.keys(i).join("")+"]\\w*$"),!o)throw new Error("RTA: loadingComponent is not defined");if(!i)throw new Error("RTA: trigger is not defined");return n}return _inherits(t,React.Component),_createClass(t,[{key:"componentDidMount",value:function(){Listeners.startListen()}},{key:"componentWillReceiveProps",value:function(e){this.update(e)}},{key:"componentWillUnmount",value:function(){Listeners.stopListen()}},{key:"update",value:function(e){var t=e.value,n=e.trigger,r=this.state.value,o=this.props.trigger;t===r&&r||this.setState({value:t}),n===o&&this.tokenRegExp||(this.tokenRegExp=new RegExp("["+Object.keys(n).join("")+"]\\w*$"))}},{key:"render",value:function(){var e=this,t=this.props,n=t.loadingComponent,r=t.style,o=t.containerStyle,i=_objectWithoutProperties(t,["loadingComponent","style","containerStyle"]),a=this.state,s=a.left,c=a.top,l=a.dataLoading,u=a.component,f=a.value,p=this.getSuggestions(),d=this.getTextToReplace();return React.createElement("div",{className:"rta "+(!0===l?"rta--loading":""),style:o},React.createElement("textarea",Object.assign({},this.cleanUpProps(),{ref:function(t){e.textareaRef=t},className:"rta__textarea "+(i.className||""),onChange:this.changeHandler,value:f,style:r})),(l||p)&&React.createElement("div",{style:{top:c,left:s},className:"rta__autocomplete"},p&&u&&d&&React.createElement(List,{values:p,component:u,getTextToReplace:d,onSelect:this.onSelect}),l&&React.createElement("div",{className:"rta__loader "+(null!==p?"rta__loader--suggestion-data":"rta__loader--empty-suggestion-data")},React.createElement(n,{data:p}))))}}]),t}();ReactTextareaAutocomplete.defaultProps={value:"",minChar:1};var _initialiseProps=function(){var e=this;this.state={top:0,left:0,currentTrigger:null,actualToken:"",data:null,value:"",dataLoading:!1,selectionEnd:0,selectionStart:0,component:null},this.onSelect=function(t){for(var n=e.state,r=n.selectionEnd,o=n.value,i=e.props.onChange,a=0;o[r+a]&&/\S/.test(o[r+a]);)a+=1;var s=o.slice(0,r+a),c=s.search(/\S*$/),l=c+t.length,u=s.substring(0,c)+t;e.setState({value:o.replace(s,u),dataLoading:!1},function(){var t=new Event("change",{bubbles:!0});e.textareaRef.dispatchEvent(t),i&&i(t),e.setTextareaCaret(l)}),e.closeAutocomplete()},this.getTextToReplace=function(){var t=e.state.currentTrigger,n=e.getCurrentTriggerSettings();if(!t||!n)return function(){return""};var r=n.output;return function(e){if("object"===(void 0===e?"undefined":_typeof(e))&&(!r||"function"!=typeof r))throw new Error("RTA: Output function is not defined!");return r?r(e,t):""+t+e+t}},this.setTextareaCaret=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;e.textareaRef&&(e.textareaRef.focus(),e.textareaRef.setSelectionRange(t,t))},this.getCurrentTriggerSettings=function(){var t=e.state.currentTrigger;return t?e.props.trigger[t]:null},this.getValuesFromProvider=function(){var t=e.state,n=t.currentTrigger,r=t.actualToken,o=e.getCurrentTriggerSettings();if(n&&o){var i=o.dataProvider,a=o.component;if("function"!=typeof i)throw new Error("RTA: Trigger provider has to be a function!");e.setState({dataLoading:!0});var s=i(r);s instanceof Promise||(s=Promise.resolve(s)),s.then(function(t){if("object"!==(void 0===s?"undefined":_typeof(s)))throw new Error("RTA: Trigger provider has to provide an array!");if("function"!=typeof a)throw new Error("RTA: Component should be defined!");e.setState({dataLoading:!1,data:t,component:a})}).catch(function(e){throw new Error("RTA: dataProvider fails: "+e.message)})}},this.getSuggestions=function(){var t=e.state,n=t.currentTrigger,r=t.data;return!n||!r||r&&!r.length?null:r},this.closeAutocomplete=function(){e.getSuggestions()&&e.setState({data:null})},this.cleanUpProps=function(){var t=Object.assign({},e.props),n=["loadingComponent","containerStyle","minChar","ref","onChange","className","value","trigger"];for(var r in t)n.includes(r)&&delete t[r];return t},this.changeHandler=function(t){var n=e.props,r=n.trigger,o=n.onChange,i=n.minChar,a=t.target,s=a.selectionEnd,c=a.selectionStart,l=a.value;o&&(t.persist(),o(t)),e.setState({value:l});var u=e.tokenRegExp.exec(l.slice(0,s)),f=u&&u[0];if(!f||f.length<=i)e.closeAutocomplete();else{var p=Object.keys(r),d=f&&p.find(function(e){return e===f[0]})||null,g=f.slice(1);if(d){var h=getCaretCoordinates(a,s),y=h.top,v=h.left;e.setState({top:y,left:v}),e.setState({selectionEnd:s,selectionStart:c,currentTrigger:d,actualToken:g},e.getValuesFromProvider)}}}},triggerPropsCheck=function(e){var t=e.trigger;if(!t)return Error("Invalid prop trigger. Prop missing.");for(var n=Object.entries(t),r=0;r<n.length;r+=1){var o=_slicedToArray(n[r],2),i=o[0],a=o[1];if("string"!=typeof i||1!==i.length)return Error("Invalid prop trigger. Keys of the object has to be string.");var s=a.component,c=a.dataProvider;if(!s||"function"!=typeof s)return Error("Invalid prop trigger: component should be defined.");if(!c||"function"!=typeof c)return Error("Invalid prop trigger: dataProvider should be defined.")}return null};ReactTextareaAutocomplete.propTypes={trigger:triggerPropsCheck,loadingComponent:PropTypes.func.isRequired,value:PropTypes.string},module.exports=ReactTextareaAutocomplete;
